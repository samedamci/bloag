#!/bin/sh

blog_title="samedamci's blog"
link="https://samedamci.me/blog/rss.xml"
description="Blog with my thoughts about world."
date="$(date +"%a, %d %b %Y %H:%M:%S +0200")"

init() {
printf "%s\n" \
"<rss version=\"2.0\" xmlns:atom=\"http://www.w3.org/2005/Atom\">
<!-- Deployed with bloag (https://git.samedamci.me/samedamci/bloag) -->
<channel>
<title>$blog_title</title>
<link>$link</link>
<description>$description</description>
<lastBuildDate>$date</lastBuildDate>
</channel>
</rss>" >"$rss_file"
}

post_title() {
  grep -m 1 "a href=\"#[0-9].*" /tmp/bloag_site.html | \
    sed "s/.*<\/p> //g; s/<.*//g"
}

get_post_body() {
  line="$(grep -in "^ *<\/div>" /tmp/bloag_site.html | sed 's/\:.*<\/div>//g; 1q')"
  line2="$(head -n "${line}" /tmp/bloag_site.html | grep -m 1 -in \
    "<div id=\".*\" class=\"project\"" | sed 's/\:.*<div.*//g; 1q'
  )"
  head -n "${line}" /tmp/bloag_site.html | sed "1,${line2}d" | \
    tee /tmp/bloag_site2.html | sed '1d; $ d' | sed 's/\//\\\//g; s/\"/\\\"/g' | \
      tr -d '\n' | sed 's/   //g; s/  / /g; s/^ //g;'
}

get_id() {
  post_body="$(get_post_body)"
  sed 's/.*href="#//g; s/">.*//g; 1q' /tmp/bloag_site2.html
}

render_xml_post() {
post_body="$(get_post_body)"
sed -i "s/<\/lastBuildDate>/<\/lastBuildDate>\n\
<item>\n\
<title>$(post_title)<\/title>\n\
<description><![CDATA[\n\
$post_body\n\
]]><\/description>\n\
<pubDate>$date<\/pubDate>\n\
<\/item>/g; s/<lastBuildDate>.*<\/lastBuildDate>/\
<lastBuildDate>$date<\/lastBuildDate>/g" "$rss_file"
}

help_message="
Usage: bloag [-h] [-H HTML file] [-R RSS file] [-M Markdown file]

  -H FILE       HTML file
  -R FILE       RSS file
  -M FILE       Markdown file
"

while getopts 'R:H:M:h' c
do
  case $c in
    R) rss_file="$OPTARG";;
    H) html_file="$OPTARG" && cp "$OPTARG" /tmp/bloag_site.html;;
    M) md_file="$OPTARG";;
    h) echo "$help_message"; exit 0;;
    [?]) echo "Invalid option, use '-h'."; exit 1;;
  esac
done

html_date="$(date +"%Y-%m-%d %H:%M")"

if [ -f "$HOME/.cache/bloag" ]; then
  new_number="$(( $(cat "$HOME/.cache/bloag") + 1))"
else
  new_number="$(( "$(get_id)" + 1 ))"
fi

echo "$new_number" > "$HOME/.cache/bloag"

get_html_post_body() {
echo "<div id=\"$new_number\" class=\"project\">"
pandoc -f markdown "$md_file" | \
sed "s/<p>//g;\
s/<\/p>//g; s/<h1 id=\".*\">/<a href=\"#$new_number\"><h3><p class=\"wt\">\#$new_number<\/p> /g;\
s/<\/h1>/<\/h3><\/a>/g"
printf "%s\n</div>\n" "<div class=\"date\">$html_date</div>"
}

html_post_body="$(get_html_post_body | sed 's/\//\\\//g; s/\"/\\\"/g' | \
  tr -d '\n' | sed 's/   //g; s/  / /g; s/^ //g')"

render_html_post() {
sed -i "s/<div id=\"main_info\">/<div id=\"main_info\">\n$html_post_body/g" /tmp/bloag_site.html
sed -i "s/<\/h3><\/a>/<\/h3><\/a>\n/g; s/<\/div><\/div>/<\/div>\n<\/div>/g;\
s/\" class=\"project\">/\" class=\"project\">\n/g;\
s/<div class=\"date\"/\n<div class=\"date\"/g" /tmp/bloag_site.html
sed -i '/^$/d' /tmp/bloag_site.html
cp /tmp/bloag_site.html "$html_file"
}

if [ ! -f "$rss_file" ]; then
  init
  rm -f "$HOME/.cache/bloag"
  echo "Initialized new file, please run command again!"
else

  last_id="$([ -f "$HOME/.cache/bloag" ] && cat "$HOME/.cache/bloag")"
  if [ "$last_id" = "$(get_id)" ]; then
    echo "dadadalkfhal"
    exit 111
  fi
  render_html_post
  render_xml_post
fi

rm -f /tmp/bloag*
