#!/bin/sh

blog_url="https://samedamci.me/blog/index.html"
blog_title="samedamci's blog"
href="/blog/rss.xml"
link="/blog"
description="Blog with my thoughts about world."
output="test.xml"

init() {
printf "%s\n" \
"<rss version=\"2.0\">
<!-- Deployed with bloag (https://git.samedamci.me/samedamci/bloag) -->
<channel>
<atom:link href=\"$href\" rel=\"self\" type=\"application/rss+xml\"/>
<title>$blog_title</title>
<link>$link</link>
<description>$description</description>
<lastBuildDate>$date</lastBuildDate>
</channel>
</rss>" >"$output"
}

parse_site() {
  curl -s "$blog_url" > /tmp/blugger_site.html

  post_title="$(
  grep -m 1 "a href=\"#[0-9].*" /tmp/blugger_site.html | \
    sed "s/.*<\/p> //g; s/<.*//g"
  )"

  line="$(grep -in "^ *<\/div>" /tmp/blugger_site.html | awk 'NR==1 {print $1}')"
  line2="$(head -n "${line%?}" /tmp/blugger_site.html | grep -m 1 -in \
    "<div id=\".*\" class=\"project\"" | awk 'NR==1 {print $1}'
  )"
  head -n "${line%?}" /tmp/blugger_site.html > /tmp/blugger_site2.html
  sed "1,${line2%?}d" /tmp/blugger_site2.html | sed '1d; $ d' | \
    sed 's/\//\\\//g; s/\"/\\\"/g' | tr '\n' '\\n' | sed 's/   //g; s/  / /g; s/^ //g'
}

content="$(parse_site)"

add_post() {
sed -i "s/<\/lastBuildDate>/<\/lastBuildDate>\n\
<item>\n\
<title>$post_title<\/title>\n\
<link>\\$post_link<\/link>\n\
<description>\n\
$content\n\
<\/description>\n\
<pubDate>$date<\/pubDate>\n\
<\/item>/g; s/<lastBuildDate>.*<\/lastBuildDate>/\
<lastBuildDate>$date<\/lastBuildDate>/g" "$output"
}

backup() {
  cp "$output" "$output.backup"
}


post_link="$link"

date="$(date +"%a, %d %b %Y %H:%M:%S +0200")"

backup
# add_post
init

rm /tmp/blugger*
